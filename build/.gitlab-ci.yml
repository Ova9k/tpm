image: davidczech/go-tpm-sim:latest

before_script:
  - mkdir -p /etc/apt
  - echo "Acquire::http::Proxy \"http://proxy-us.intel.com:911\";" >> /etc/apt/apt.conf
  - echo "Acquire::https::Proxy \"http://proxy-us.intel.com:911\";" >> /etc/apt/apt.conf
  - git config --global http.proxy "http://proxy-us.intel.com:911"
  - git config --global http."https://gitlab.devtools.intel.com".proxy ""
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.devtools.intel.com".insteadOf "https://gitlab.devtools.intel.com"
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - cd $CI_PROJECT_DIR

variables:
  HTTPS_PROXY: http://proxy-us.intel.com:911
  no_proxy: ".intel.com"

stages:
  - build
  - test
  - deploy

test:
  stage: test
  tags:
    - go
  script:
    - start12 > /dev/null &
    - start20 > /dev/null &
    - start20_legacy > /dev/null &
    - sleep 3
    - provision12 1234 5678
    - provision20 1234 5678
    - provision20_legacy 1234 5678
    - go test -tags=integration -cover
  
compile:
  stage: build
  tags:
    - go
  script:
    - go build ./...

tool:
  stage: deploy
  tags:
    - go
  script:
    - go build -o tpm cmd/tpm/main.go
  artifacts:
    paths:
      - "tpm"